<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- Swiper's CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="stylesheet" href="../../assets/css/style.min.css">
    <link rel="stylesheet" href="../../assets/css/temp.css">
</head>
<body>

<div id="container">
    <div id="contents" class="main">
        <div class="main-visual-wrap">
            <div class="main-intro">
                <!-- logo -->
                <div class="scene-logo"></div>

                <!-- slide -->
                <div class="scene-slide">
                    <div class="scene-slide-inner">
                        <div class="swiper-visual-wrap mask" id="trigger">
                            <div class="swiper-visual" id="slide">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide" data-duration="5000">
                                        <div class="video-frame bg1">
                                            <video src="../../assets/media/main_vs2.mp4" class="responsive-video" muted autoplay playsinline></video>
                                        </div>
                                        <div class="text">
                                            <div class="text-1" id="target">
                                                <p>VIEW, <br class="mo-only">Perspective <br class="mo-only">of Life</p>
                                            </div>
                                            <div class="text-2">
                                                <p>가치를 보는 안목 </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swiper-slide" data-duration="5000">
                                        <div class="video-frame bg2">
                                            <video src="../../assets/media/v3.mp4" class="responsive-video" muted autoplay playsinline></video>
                                        </div>
                                        <div class="text">
                                            <div class="text-1">
                                                <p>VIEW, <br class="mo-only">Perspective <br class="mo-only">of Life</p>
                                            </div>
                                            <div class="text-2">
                                                <p>본질을 보는 혜안 </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swiper-slide" data-duration="5000">
                                        <div class="video-frame bg3" style="background-color: aquamarine;">
                                            
                                        </div>
                                        <div class="text">
                                            <div class="text-1">
                                                <p>VIEW, <br class="mo-only">Perspective <br class="mo-only">of Life</p>
                                            </div>
                                            <div class="text-2">
                                                <p>보여지는 것 너머 <br class="mo-only">보이지 않는 삶을 보는 섬세함</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="swiper-nav">
                                    <div class="swiper-controls">
                                        <button type="button" class="swiper-button-prev">
                                            <i class="ico-prev"><span class="blind">이전</span></i>
                                        </button>
                                        <div class="swiper-pagination"></div>
                                        <button type="button" class="swiper-button-next">
                                            <i class="ico-next"><span class="blind">다음</span></i>
                                        </button>                          
                                        <button type="button" class="swiper-button-play"><span class="blind">재생</span></button>
                                        <button type="button" class="swiper-button-pause"><span class="blind">정지</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main-section-wrap">
            <div class="main-garo">
                <div class="horizontal-wrap"></div>
            </div>
            <div class="main-quickMenu" style="height:400vh"></div>
        </div> 
    </div>   
</div>

    




<!-- Swiper's JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<!-- Custom JS -->
<script src="../../assets/js/gsap.min.js"></script>
<script src="../../assets/js/ScrollTrigger.min.js"></script>
<script src="../../assets/js/SplitText.min.js"></script>
<script src="../../assets/js/lenis.min.js"></script>
<script>

// mainVsSwiper.js — Swiper 메인 비주얼(영상/이미지 혼합) + 진행바 동기화 통합 개선판
// 작성 의도: 안정성(이벤트 누수 방지), 일관성(진행바 초기화), 접근성(버튼 상태 갱신), 반응형(breakpoints) 강화

function mainVsSwiper(options = {}) {
  const autoplayDelay = options.autoplayDelay ?? 5000; 
  const selector = options.selector ?? '.swiper-visual';  
  const container = document.querySelector(selector);
  if (!container) {
    console.warn(`[mainVsSwiper] ${selector} 요소를 찾을 수 없습니다.`);
    return;
  }
  if (options.startPaused) {
    container.classList.add('is-paused');
  }
  // 진행바 기본 둘레값(r=14 => 2πr ≈ 88)
  const CIRCUMFERENCE = 88;
  // keyframes 존재 보장 (progress-animation)
  (function ensureProgressKeyframes() {
    const id = 'progress-animation-style';
    if (document.getElementById(id)) return;
    const style = document.createElement('style');
    style.id = id;
    style.textContent = `@keyframes progress-animation { to { stroke-dashoffset: 0; } }`;
    document.head.appendChild(style);
  })();
  // 진행바 상태 초기화/리셋 도우미
  function initProgressBarState(bar) {
    if (!bar) return;
    bar.style.strokeDasharray = String(CIRCUMFERENCE);
    bar.style.strokeDashoffset = String(CIRCUMFERENCE);
  }
  function resetAllProgressBars(swiperInstance) {
    const bars = swiperInstance?.pagination?.bullets?.length
      ? Array.from(swiperInstance.pagination.bullets).map((b) => b.querySelector('.progress-bar')).filter(Boolean)
      : Array.from(document.querySelectorAll('.swiper-pagination-bullet .progress-bar'));

    bars.forEach((bar) => {
      bar.style.animation = 'none';     
      bar.offsetWidth;
      initProgressBarState(bar);
      bar.style.animationPlayState = 'paused';
    });
  }
  // 이전 슬라이드의 비디오 이벤트 해제용 보관
  let unbindPrevVideo = null;
  function wireVideo(swiperInstance, video, progressBar, wasPaused) {
    if (!video) return () => {};

    // iOS/모바일 호환
    video.muted = true;
    video.playsInline = true;

    const setupVideo = () => {
      // 영상 길이에 맞춰 진행바 구동
      progressBar.style.animation = `progress-animation ${video.duration}s linear forwards`;
      if (wasPaused) {
        progressBar.style.animationPlayState = 'paused';
        video.pause();
      } else {
        progressBar.style.animationPlayState = 'running';
        const playPromise = video.play();
        if (playPromise && typeof playPromise.catch === 'function') {
          playPromise.catch((err) => {
            console.error('[mainVsSwiper] Video play was prevented:', err);
            // 영상 재생 불가 시 다음 슬라이드로 안전 탈출
            setTimeout(() => swiperInstance.slideNext(), 200);
          });
        }
      }
    };

    const onEnded = () => {
      // 일시정지 상태가 아닐 때에만 다음으로 진행
      if (!container.classList.contains('is-paused') && swiperInstance.pagination.bullets.length > 1) {
        swiperInstance.slideNext();
      }
    };

    // 메타데이터 준비 상태에 따라 즉시/지연 설정
    if (video.readyState >= 1) {
      setupVideo();
    } else {
      video.addEventListener('loadedmetadata', setupVideo, { once: true });
    }

    video.addEventListener('ended', onEnded);
    // 해제 함수 반환
    return () => {
      video.removeEventListener('ended', onEnded);
    };
  }

  function handleSlideChange(swiperInstance, isInit = false) {
    const wasPaused = container.classList.contains('is-paused');
    
    // 진행바 전부 초기화
    resetAllProgressBars(swiperInstance);
    // 활성 슬라이드/벌렛/진행바 찾기
    const activeSlide = swiperInstance.slides[swiperInstance.activeIndex];
    const activeBullet = swiperInstance.pagination.bullets[swiperInstance.realIndex];
    if (!activeSlide || !activeBullet) return;
    const progressBar = activeBullet.querySelector('.progress-bar');
    if (!progressBar) return;

    // 이전 비디오 이벤트 해제
    if (unbindPrevVideo) { unbindPrevVideo(); unbindPrevVideo = null; }
    const video = activeSlide.querySelector('video');
    if (video) { 
      swiperInstance.autoplay.stop();
      video.currentTime = 0;
      initProgressBarState(progressBar);
      unbindPrevVideo = wireVideo(swiperInstance, video, progressBar, wasPaused);
    } else {
      const duration = parseInt(activeSlide.getAttribute('data-duration'), 10) || autoplayDelay;
      swiperInstance.params.autoplay.delay = duration;
      initProgressBarState(progressBar);      
      progressBar.style.animation = `progress-animation ${duration / 1000}s linear forwards`;

      if (wasPaused) {
        swiperInstance.autoplay.stop();
        progressBar.style.animationPlayState = 'paused';
      } else {
        // 변경된 delay가 즉시 반영되도록 stop → start 순서로 재시작
        swiperInstance.autoplay.stop();
        swiperInstance.autoplay.start();
        progressBar.style.animationPlayState = 'running';
      }
    }
  }

  const swiperOptions = {
    loop: true,
    autoplay: {
      delay: autoplayDelay,
      disableOnInteraction: false,
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
      renderBullet: function (index, className) {
        return (
          `<button type="button" class="${className}">` +
          `  <svg class="progress-circle" viewBox="0 0 30 30">` +
          `    <circle class="bg" cx="15" cy="15" r="14"></circle>` +
          `    <circle class="progress-bar" cx="15" cy="15" r="14"></circle>` +
          `  </svg>` +
          `  <span>${index + 1}</span>` +
          `</button>`
        );
      },
    },
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    breakpoints: {
      0: {
        touchRatio: 1,
        touchAngle: 45,
        resistanceRatio: 0.5,
      },
      1025: {
        touchRatio: 0.7,
        touchAngle: 45,
        resistanceRatio: 0.85,
      },
    },
    on: {
      init() {
        handleSlideChange(this, true);
      },
      slideChange() {
        handleSlideChange(this, false);
      },
    },
  };

  let swiper;
  try {
    swiper = new Swiper(selector, swiperOptions);
  } catch (error) {
    console.warn('[mainVsSwiper] Swiper 초기화 실패:', error);
    return;
  }
  const playBtn = document.querySelector('.swiper-button-play');
  const pauseBtn = document.querySelector('.swiper-button-pause');

  function playSlider() {
    container.classList.remove('is-paused');
    const activeSlide = swiper.slides[swiper.activeIndex];
    const video = activeSlide?.querySelector('video');
    const activeBullet = swiper.pagination.bullets[swiper.realIndex];
    const bar = activeBullet?.querySelector('.progress-bar');

    if (bar) bar.style.animationPlayState = 'running';

    if (video) {      
      const p = video.play();
      if (p && typeof p.catch === 'function') p.catch(() => {});
    } else {      
      swiper.autoplay.stop();
      swiper.autoplay.start();
    }

    playBtn?.setAttribute('aria-pressed', 'true');
    pauseBtn?.setAttribute('aria-pressed', 'false');
  }

  function pauseSlider() {
    container.classList.add('is-paused');
    const activeSlide = swiper.slides[swiper.activeIndex];
    const video = activeSlide?.querySelector('video');
    const activeBullet = swiper.pagination.bullets[swiper.realIndex];
    const bar = activeBullet?.querySelector('.progress-bar');
    if (bar) bar.style.animationPlayState = 'paused';
    if (video) video.pause();
    else swiper.autoplay.stop();
    pauseBtn?.setAttribute('aria-pressed', 'true');
    playBtn?.setAttribute('aria-pressed', 'false');
  }

  playBtn?.addEventListener('click', playSlider);
  pauseBtn?.addEventListener('click', pauseSlider);

  // 탭 비활성화/복귀 시 처리(UX 안정화)
  document.addEventListener('visibilitychange', () => {
    const activeSlide = swiper.slides[swiper.activeIndex];
    const video = activeSlide?.querySelector('video');
    const activeBullet = swiper.pagination.bullets[swiper.realIndex];
    const bar = activeBullet?.querySelector('.progress-bar');

    if (document.hidden) {
      swiper.autoplay.stop();
      if (video) video.pause();
      if (bar) bar.style.animationPlayState = 'paused';
    } else if (!container.classList.contains('is-paused')) {
      if (video) {
        const p = video.play();
        if (p && typeof p.catch === 'function') p.catch(() => {});
      } else {
        swiper.autoplay.stop();
        swiper.autoplay.start();
      }
      if (bar) bar.style.animationPlayState = 'running';
    }
  });

  return {
    play: playSlider,
    pause: pauseSlider,
    swiper,
  };
}


document.addEventListener('DOMContentLoaded', () => {
    let isPC = window.matchMedia("(min-width: 1025px)").matches;
    

    function initPc() {
        window.mainVisualSlider = mainVsSwiper({ startPaused: true });
    }

    function pcMotion() {
        const main = document.querySelector(".scene-slide-inner");
        ScrollTrigger.create({
            trigger : ".scene-slide",
            start : "top top",
            end: () => `+=${main.clientHeight * 1.4}`,
            pin: true,
            invalidateOnRefresh: true,
            anticipatePin: 1,
            onEnter : () => {
                const tl = gsap.timeline();
                gsap.fromTo(".mask",{
                        clipPath: "polygon(10% 18%, 90% 18%, 90% 80%, 10% 80%)",
                    },{
                        clipPath: "polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)",
                        duration: 0.5,
                        ease: "power2.out",
                        scrollTrigger: {
                            trigger: ".scene-slide",
                            start: "top top",
                            end: "top 70%",
                            scrub: true,
                            invalidateOnRefresh: true,
                        },                   
                    }
                );
                         
                if (window.mainVisualSlider) {      
                    window.mainVisualSlider.swiper.slideToLoop(0);              
                    window.mainVisualSlider.play();
                }
               

            },
            onLeaveBack: () => {
                
                gsap.set(".mask", {
                    clipPath: "polygon(10% 18%, 90% 18%, 90% 80%, 10% 80%)",
                });
                
                if (window.mainVisualSlider) {
                    window.mainVisualSlider.pause();
                    window.mainVisualSlider.swiper.slideToLoop(0);
                }

            }
        })
    }

    function initMo() {
      window.mainVisualSlider = mainVsSwiper();
    }


    if(isPC) {
      initPc();
      pcMotion();
    } else {
      initMo()
    }

    window.addEventListener("resize", () => {
    const nowIsPC = window.matchMedia("(min-width: 1025px)").matches;
    if (nowIsPC !== isPC) {
      isPC = nowIsPC;
      if (isPC) {
        
        initPc();
        pcMotion();
      } else {
        initMo();
        //initMOMotion();
      }
    }
    if (window.mainVisualSlider) {
      window.mainVisualSlider.swiper.update();
    }
    ScrollTrigger.refresh();
  });

});


</script>



</body>
</html>